<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Reply | BNS</title>

<!-- SUPABASE -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="supabase.js"></script>

<style>
body{
  font-family:'Segoe UI',Tahoma,Verdana,sans-serif;
  margin:0;
  background:#f5f5f5;
}

/* TOP BAR */
.top{
  position:fixed;
  top:0;left:0;right:0;
  background:#FF9933;
  padding:15px 30px;
  color:#fff;
  font-weight:bold;
  display:flex;
  justify-content:space-between;
  align-items:center;
  z-index:10;
}

/* CHAT AREA */
.chat-box{
  max-width:900px;
  margin:90px auto 90px;
  padding:20px;
}

/* MESSAGE */
.msg{
  max-width:65%;
  padding:12px 16px;
  border-radius:14px;
  margin-bottom:12px;
  line-height:1.4;
  font-size:15px;
  word-wrap:break-word;
}

/* LEFT (THEIR MESSAGE) */
.left{
  background:#ffffff;
  border:1px solid #ddd;
}

/* RIGHT (MY MESSAGE) */
.right{
  background:#dcf8c6;
  margin-left:auto;
}

/* TIME */
.time{
  font-size:11px;
  opacity:.6;
  margin-top:4px;
  text-align:right;
}

/* INPUT */
.reply-box{
  position:fixed;
  bottom:0;left:0;right:0;
  background:#fff;
  padding:15px;
  display:flex;
  gap:10px;
  border-top:1px solid #ddd;
}

textarea{
  flex:1;
  resize:none;
  padding:12px;
  border-radius:10px;
  border:1px solid #ccc;
  font-size:14px;
}

button{
  background:#138808;
  color:#fff;
  border:none;
  border-radius:10px;
  padding:0 22px;
  font-weight:bold;
  cursor:pointer;
}
</style>
</head>

<body>

<div class="top">
  <span id="title">Chat</span>
  <span onclick="back()" style="cursor:pointer">← Back</span>
</div>

<div class="chat-box" id="chat"></div>

<div class="reply-box">
  <textarea id="reply" placeholder="Type a reply..."></textarea>
  <button onclick="sendReply()">Send</button>
</div>

<script>
/* AUTH */
const myId = String(sessionStorage.getItem("loginid"));
const chatid = sessionStorage.getItem("chatid");
const otherId = String(sessionStorage.getItem("otherid"));
const otherName = sessionStorage.getItem("othername");

if(!myId || !chatid){
  location.replace("Chat");
}

document.getElementById("title").textContent = otherName || "Chat";

/* LOAD MESSAGES */
async function loadMessages(){
  const { data, error } = await window.db
    .from("chat_messages")
    .select("*")
    .eq("chatid", chatid)
    .order("time", { ascending: true });

  if(error) return;

  const box = document.getElementById("chat");
  box.innerHTML = "";

  data.forEach(m => {
    const div = document.createElement("div");

    /* ✅ FIXED LEFT / RIGHT LOGIC */
    div.className = "msg " + (String(m.senderid) === myId ? "right" : "left");

    div.innerHTML = `
      ${m.message}
      <div class="time">${new Date(m.time).toLocaleTimeString()}</div>
    `;

    box.appendChild(div);
  });

  box.scrollTop = box.scrollHeight;
}

/* MARK AS READ */
async function markRead(){
  await window.db
    .from("chat_conversations")
    .update({ unread_for: null })
    .eq("chatid", chatid);
}

/* SEND REPLY */
async function sendReply(){
  const text = reply.value.trim();
  if(!text) return;

  const { data: me } = await window.db
    .from("logininfo")
    .select("username")
    .eq("loginid", myId)
    .single();

  await window.db.from("chat_messages").insert({
    chatid: chatid,
    senderid: myId,
    sendername: me.username,
    message: text
  });

  await window.db.from("chat_conversations").update({
    last_message: text,
    last_time: new Date(),
    unread_for: otherId
  }).eq("chatid", chatid);

  reply.value = "";
  loadMessages();
}

/* BACK */
function back(){
  location.href = "Chat";
}

markRead();
loadMessages();
</script>

</body>
</html>
